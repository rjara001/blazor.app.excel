@using BlazorAppExcel.Components.Cells
@using BlazorAppExcel.Components.atomic
@using BlazorAppExcel.Interfaces
@using BlazorAppExcel.Models
@using BlazorAppExcel.Share.Enums
@using BlazorAppExcel.Share.Models
@using System.Linq;

@inject ISessionSingletonService session
@inject IExcelService excel;

@page "/design/columns/{IdTableSelected?}"

@if (_tables != null && _tables.Count() > 0)
{

    <Dropdown>
        <DropdownToggleButton Color="ButtonColor.Secondary">Tables</DropdownToggleButton>
        <DropdownMenu>
               @foreach (TableExcel item in this._tables)
                {
                    <DropdownItem @onclick="@(()=>OnTableSelected(item))" To="#" Type="ButtonType.Button">@item.Name</DropdownItem>
                }
            
        </DropdownMenu>
    </Dropdown>
}

<table class="table">
    <thead>
        <tr>
            <th></th>
            <th>Name</th>
            <th>Type</th>

        </tr>
    </thead>
    <tbody>
            @if (TableSelected!=null)
            {
                
                @for (int index = 0; index < this.TableSelected.GetColumnTables.Count; index++)
                {
                    ColumnTable item = this.TableSelected.GetColumnTables[index];
                    var indexItem = index;
                <tr>
                    <td>
                        @* <Icon Icon="@IconName.Alarm" aria-label="delete" OnClick="@(()=>OnDeleteItem(item, indexItem))"></Icon> *@
                        <a @onclick:preventDefault="true" @onclick="@(e => OnDeleteItem(item, indexItem))" href="#" class="text-decoration-none">
                            <Icon Name="IconName.Trash"></Icon>
                        </a>
                    </td>
                        <td>
                            @if (this._editableNameColumn == item.Key)
                            {
                            <CellTextElement Value="@item.Name" Name="@item.Name" OnChildParameterChanged="@((value)=>UpdateChildParameter(value, item))" OnBlur="@(()=>this._editableTypeColumn=String.Empty)"></CellTextElement>
                            }
                            else
                            {
                                <div onclick="@(()=>EditNameColumn(item.Key))">@item.Name</div>
                            }
                        </td>
                        <td>
                            @if (this._editableTypeColumn == item.Key)
                            {
                                <CellSelectElement Index="@index" Value="@item.IdType.ToString()" Values="@GetTypes()" OnChildParameterChanged="@((string e)=>UpdateType(indexItem, e, item))" OnBlur="@(()=>this._editableTypeColumn=String.Empty)"></CellSelectElement>
                  
                            }
                            else
                            {
                                <div onclick="@(()=>EditTypeColumn(item.Key))">@item.Type.ToString()</div>
                            }
                    </td>

                    </tr>
                }
            }
    </tbody>
</table>

<Button onclick="@AddItem" Color="ButtonColor.Primary" Size="Size.Small">Add Item</Button>
<ConfirmDialog @ref="dialog" />

@code {
    private string _idTableSelected = null;
    private TableExcel TableSelected;
    private IList<TableExcel> _tables = null;
    private string _editableTypeColumn = string.Empty;
    private string _editableNameColumn = string.Empty;

    private ConfirmDialog dialog = default!;

    public void OnTableSelected(TableExcel tableExcel)
    {
        this.TableSelected = tableExcel;
    }

    [Parameter] public string IdTableSelected { get
        {
            if (this._tables.Count() > 0 && this._idTableSelected == null)
                this._idTableSelected = this._tables[0].Id;

            return this._idTableSelected;
        }
        set
        {
            this._idTableSelected = value;
        }
    }

    private string IdColumn { get; set; }

    private async void UpdateChildParameter(string value, ColumnTable item)
    {
        Console.WriteLine("value:" + value);

        int index = this.TableSelected.Columns.IndexOf(item.Name);

        this.TableSelected.Columns[index] = value;

        await excel.SetUser(session.User, TableSelected);

    }

    private async void OnDeleteItem(ColumnTable item, int index)
    {
        try
        {
            var confirmation = await dialog.ShowAsync(
    title: "Are you sure you want to delete this?",
    message1: "This will delete the record. Once deleted can not be rolled back.",
    message2: "Do you want to proceed?");

            if (confirmation)
            {
                // do something
                DeleteColumn(item, index);
            }
        }
        catch (Exception e)
        {
            
            throw;
        }


    }

    private async void DeleteColumn(ColumnTable item, int index)
    {
        TableSelected.Types.RemoveAt(index);
        TableSelected.Columns.Remove(item.Key);

        foreach (RowExcel row in TableSelected.Rows)
        {
            row.Values.RemoveAt(index);
        }

        await excel.SetUser(session.User, TableSelected);

        this.StateHasChanged();
    }

    private async void OnSaveTypeChanges(ExcelCellType type, int index)
    {

        TableSelected.Types[index] = (int)type;

        await excel.SetUser(session.User, TableSelected);
    }

    private async Task OnSaveChanges(string value, ColumnTable item, int index)
    {

        TableSelected.Columns[index] = value;

        TableSelected.Types[index] = item.IdType;

        await excel.SetUser(session.User, TableSelected);
    }

    private async void UpdateType(int index, string newValue, ColumnTable item)
    {
 
        item.IdType = Convert.ToInt16(newValue);

        await OnSaveChanges(item.Name, item, index);
    }

    private void EditTypeColumn(string keyColumn)
    {

        this._editableTypeColumn = keyColumn;
        this.StateHasChanged();
    }

    private void EditNameColumn(string keyColumn)
    {

        this._editableNameColumn = keyColumn;
        this.StateHasChanged();
    }

    // private List<ExcelCellType> GetTypes()
    // {
    //     var obj = Enum.GetValues(typeof(ExcelCellType))
    //                                        .Cast<ExcelCellType>()
    //                                        .ToList();

    //     return obj;
    // }
    private IDictionary<string, string> GetTypes()
    {
        var obj = Enum.GetValues(typeof(ExcelCellType)).Cast<ExcelCellType>().ToDictionary(
                                                                        e => ((int)e).ToString(),
                                                                        e => e.ToString());

        return obj;
    }

    async void AddItem()
    {

        this.TableSelected.Columns.Add("new column");
        this.TableSelected.Types.Add((int)Share.Enums.ExcelCellType.String);

        foreach (RowExcel row in TableSelected.Rows)
        {
            row.Values.Add("");
        }

        await this.excel.SetUser(session.User, this.TableSelected);
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        this._tables = this.session.User.TablesToList();

        Task.Run(() =>
        {
            foreach (var item in this._tables)
            {
                item.EnsureListsBalanced();
            }
        });

       

    }

    Func<TableExcel, string> converter = p => p?.Name;

    Func<ExcelCellType, string> converterEnum = p => p.ToString();
}
